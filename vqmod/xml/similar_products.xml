<modification>
	<id>Similar products</id>
	<version>1.1</version>
	<vqmver>2.1.5</vqmver>
	<author>made by zubovd</author>
	<file name="catalog/controller/product/product.php">
		<operation>
			<search position="before">
				<![CDATA[
					$this->data['products'] = array();
				]]>
			</search>
			<add>
				<![CDATA[
// product similar
			$this->data['products_similar'] = array();

			$similar = $this->model_catalog_product->getProductSimilar($this->request->get['product_id'],5);

			foreach ($similar as $result) {
				if ($result['image']) {
					$image = $this->model_tool_image->resize($result['image'], $this->config->get('config_image_related_width'), $this->config->get('config_image_related_height'));
				} else {
					$image = false;
				}

				if (($this->config->get('config_customer_price') && $this->customer->isLogged()) || !$this->config->get('config_customer_price')) {
					$price = $this->currency->format($this->tax->calculate($result['price'], $result['tax_class_id'], $this->config->get('config_tax')));
				} else {
					$price = false;
				}

				if ((float)$result['special']) {
					$special = $this->currency->format($this->tax->calculate($result['special'], $result['tax_class_id'], $this->config->get('config_tax')));
				} else {
					$special = false;
				}

				if ($this->config->get('config_review_status')) {
					$rating = (int)$result['rating'];
				} else {
					$rating = false;
				}

				$this->data['products_similar'][] = array(
					'product_id' => $result['product_id'],
					'thumb'   	 => $image,
					'name'    	 => $result['name'],
					'price'   	 => $price,
					'special' 	 => $special,
					'rating'     => $rating,
					'reviews'    => sprintf($this->language->get('text_reviews'), (int)$result['reviews']),
					'href'    	 => $this->url->link('product/product', 'product_id=' . $result['product_id']),
				);
			}
// product similar
				]]>
			</add>
		</operation>
		<operation>
			<search position="after">
				<![CDATA[
					$this->data['tab_attribute'] = $this->language->get('tab_attribute');
				]]>
			</search>
			<add>
				<![CDATA[
	$this->data['tab_similar'] = $this->language->get('tab_similar');
				]]>
			</add>
		</operation>
	</file>
	<file name="catalog/language/russian/product/product.php">
        <operation>
            <search position="after"><![CDATA[
            $_['tab_attribute']     = 'Характеристики';
            ]]></search>
            <add><![CDATA[
	$_['tab_similar']		= 'Похожие товары';
            ]]></add>
        </operation>
	</file>
	<file name="catalog/view/theme/*/template/product/product.tpl">
		<operation>
			<search position="before" index="2">
				<![CDATA[
					<?php if ($review_status) { ?>
				]]>
			</search>
			<add>
				<![CDATA[
<!-- similar products-->
    <?php if ($products_similar) { ?>
    <a href="#tab-similar"><?php echo $tab_similar; ?></a>
    <?php } ?>
<!-- similar products-->
				]]>
			</add>
		</operation>
		<operation>
			<search position="before" index="3">
				<![CDATA[
					<?php if ($review_status) { ?>
				]]>
			</search>
			<add>
				<![CDATA[
<!-- similar products-->
  <?php if ($products_similar) { ?>
  <div id="tab-similar" class="tab-content">
    <div class="box-product">
      <?php foreach ($products_similar as $product) { ?>
      <div>
        <?php if ($product['thumb']) { ?>
        <div class="image"><a href="<?php echo $product['href']; ?>"><img src="<?php echo $product['thumb']; ?>" alt="<?php echo $product['name']; ?>" /></a></div>
        <?php } ?>
        <div class="name"><a href="<?php echo $product['href']; ?>"><?php echo $product['name']; ?></a></div>
        <?php if ($product['price']) { ?>
        <div class="price">
          <?php if (!$product['special']) { ?>
          <?php echo $product['price']; ?>
          <?php } else { ?>
          <span class="price-old"><?php echo $product['price']; ?></span> <span class="price-new"><?php echo $product['special']; ?></span>
          <?php } ?>
        </div>
        <?php } ?>
        <?php if ($product['rating']) { ?>
        <div class="rating"><img src="catalog/view/theme/default/image/stars-<?php echo $product['rating']; ?>.png" alt="<?php echo $product['reviews']; ?>" /></div>
        <?php } ?>
        <a onclick="addToCart('<?php echo $product['product_id']; ?>');" class="button"><span><?php echo $button_cart; ?></span></a></div>
      <?php } ?>
    </div>
  </div>
  <?php } ?>
<!-- similar products-->
				]]>
			</add>
		</operation>
	</file>
	<file name="catalog/model/catalog/product.php">
        <operation>
            <search position="before"><![CDATA[
	public function getProductLayoutId($product_id) {
            ]]></search>
            <add><![CDATA[
// product similar
	public function getProductSimilar($product_id,$limit) {
		$product_data = array();
		// находим категорию, в которой нах. товар
		$category = $this->db->query("SELECT category_id FROM " . DB_PREFIX . "product_to_category WHERE product_id = '" .$product_id. "'");
		$category_id = $category->row['category_id'];
		// делаем выборку товаров из этой же категории, которые следуют после данного товара
		$query = $this->db->query("SELECT p.product_id FROM " . DB_PREFIX . "product p LEFT JOIN " . DB_PREFIX . "product_to_category p2c  ON (p.product_id = p2c.product_id) WHERE p2c.category_id = '" . (int)$category_id . "' AND p.status = '1' AND p.date_available <= NOW() AND p.product_id > '" .(int)$product_id. "' ORDER BY p.product_id ASC LIMIT " .(int)$limit);

		foreach ($query->rows as $result) {
			$product_data[$result['product_id']] = $this->getProduct($result['product_id']);
		}

		if(count($query->rows) < $limit){ // если в категории после товара меньше лимита...
			$plimit = $limit - count($query->rows); // вычисляем разницу и делаем выборку товаров с НАЧАЛА списка, кол-во = разнице
			$sql = $this->db->query("SELECT p.product_id FROM " . DB_PREFIX . "product p LEFT JOIN " . DB_PREFIX . "product_to_category p2c  ON (p.product_id = p2c.product_id) WHERE p2c.category_id = '" . (int)$category_id . "' AND p.status = '1' AND p.date_available <= NOW() AND p.product_id <> '" .(int)$product_id. "' ORDER BY p.product_id ASC LIMIT " .(int)$plimit);

				foreach ($sql->rows as $result) {
					$product_data[$result['product_id']] = $this->getProduct($result['product_id']);
				}
		}

		return $product_data;
	}
// product similar
            ]]></add>
        </operation>
	</file>
</modification>